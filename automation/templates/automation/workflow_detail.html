{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Workflow Info & Steps -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-primary">{{ workflow.name }}</h5>
                    <span class="badge {% if workflow.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                        {% if workflow.is_active %}AKTİF{% else %}PASİF{% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <p class="text-muted">{{ workflow.description }}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span class="me-3"><i class="fas fa-clock me-1"></i> Periyot: {{ workflow.interval_minutes }}
                            dk</span>
                        <span class="me-3"><i class="fas fa-history me-1"></i> Son: {{ workflow.last_run|default:'-'
                            }}</span>
                        <span><i class="fas fa-arrow-right me-1"></i> Sonraki: {{ workflow.next_run|default:'-'
                            }}</span>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3">İşlem Adımları (Steps)</h6>
                    <ul class="list-group list-group-flush mb-4 step-list">
                        {% for step in workflow.steps.all %}
                        <li
                            class="list-group-item d-flex justify-content-between align-items-center bg-light mb-2 border rounded">
                            <div>
                                <span class="badge bg-dark rounded-circle me-2">{{ step.order }}</span>
                                <span class="fw-bold">{{ step.task.name }}</span>
                                <div class="text-muted small ms-4">{{ step.task.description }}</div>
                            </div>
                            <form method="POST" class="d-inline"
                                onsubmit="return confirm('Bu adımı silmek istediğinize emin misiniz?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="remove_task">
                                <input type="hidden" name="step_id" value="{{ step.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </li>
                        {% empty %}
                        <li class="text-muted text-center py-3">Henüz adım eklenmemiş.</li>
                        {% endfor %}
                    </ul>

                    <!-- Add Step Form -->
                    <div class="bg-light p-3 rounded">
                        <h6 class="mb-3">Yeni Adım Ekle</h6>
                        <form method="POST" class="row g-2">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_task">
                            <div class="col-md-7">
                                <select name="task_id" class="form-select form-select-sm" required>
                                    <option value="">Görev Seçiniz...</option>
                                    {% for task in available_tasks %}
                                    <option value="{{ task.id }}">{{ task.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="number" name="order" class="form-control form-control-sm"
                                    placeholder="Sıra" value="{{ workflow.steps.count|add:1 }}" min="1">
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-sm btn-success w-100">Ekle</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Recent Logs for this Workflow -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-2">
                    <small class="fw-bold text-muted">Son Çalışma Logları (Bu Akış İçin)</small>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-striped mb-0 small">
                        <thead>
                            <tr>
                                th>Zaman</th>
                                <th>Görev</th>
                                <th>Durum</th>
                                <th>Süre</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in workflow.tasklog_set.all|slice:":10" %}
                            <tr>
                                <td>{{ log.created_at|date:"H:i:s" }}</td>
                                <td>{{ log.task_name }}</td>
                                <td>
                                    {% if log.status == 'SUCCESS' %}
                                    <span class="text-success fw-bold">OK</span>
                                    {% elif log.status == 'FAILED' %}
                                    <span class="text-danger fw-bold">HATA</span>
                                    {% else %}
                                    <span class="text-warning">{{ log.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.duration_seconds|floatformat:2 }}s</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">Log yok.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-warning text-dark py-2">
                    <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Ayarlar</h6>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_settings">

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Akış Adı</label>
                            <input type="text" name="name" class="form-control" value="{{ workflow.name }}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Açıklama</label>
                            <textarea name="description" class="form-control"
                                rows="3">{{ workflow.description }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Çalışma Aralığı (Dakika)</label>
                            <input type="number" name="interval" class="form-control"
                                value="{{ workflow.interval_minutes }}" required>
                            <div class="form-text small">Otomatik tetikleme süresi.</div>
                        </div>

                        <div class="mb-3 form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_active" id="isActive" {% if workflow.is_active %}checked{% endif %}>
                                
                            <label class="form-check-label small fw-bold" for="isActive">Otomatik Çalıştırma
                                Aktif</label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Kaydet & Güncelle</button>
                    </form>

                    <hr>

                    <a href="{% url 'workflow_run' workflow.id %}" class="btn btn-success w-100 mb-2">
                        <i class="fas fa-play me-2"></i> Şimdi Test Et
                    </a>

                    <a href="{% url 'workflow_delete' workflow.id %}" class="btn btn-outline-danger w-100">
                        <i class="fas fa-trash-alt me-2"></i> Akışı Sil
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}