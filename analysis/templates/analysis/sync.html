{% extends "base.html" %}

{% block title %}Veri Senkronizasyon Merkezi{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="fw-bold"><i class="bi bi-arrow-repeat"></i> Veri Senkronizasyon Merkezi</h2>
            <p class="text-muted">
                Åu Anki Ortam:
                {% if is_cloud %}
                <span class="badge bg-primary fs-6">â˜ï¸ AWS SUNUCUSU ({{ request.get_host }})</span>
                {% else %}
                <span class="badge bg-warning text-dark fs-6">ğŸ’» LOKAL BÄ°LGÄ°SAYAR ({{ request.get_host }})</span>
                {% endif %}
            </p>
        </div>
    </div>

    <div class="row justify-content-center">
        <!-- LOKAL OPERASYONLAR (Sadece Localhost'ta aÃ§Ä±k) -->
        <div class="col-md-5 mb-4">
            <div class="card h-100 border-warning {% if is_cloud %}bg-light opacity-50{% endif %}">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="bi bi-laptop"></i> LOKAL OPERASYON (PC'den Ã‡ek)
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        Kendi bilgisayarÄ±nÄ±zdaki tarayÄ±cÄ±yÄ± kullanarak Bilyoner'den veriyi Ã§eker ve AWS'ye gÃ¶nderir.
                        <br><b>En gÃ¼venli yÃ¶ntemdir (IP bloklanmaz).</b>
                    </p>

                    <div class="d-grid gap-2">
                        <button onclick="runLocalScrape()" class="btn btn-outline-dark" {% if is_cloud %}disabled{% endif %}>
                            

                            <i class="bi bi-arrow-clockwise"></i> 1. Veriyi Ã‡ek (GÃ¶rÃ¼nÃ¼r Mod)
                        </button>

                        <button onclick="runAwsPush()" class="btn btn-dark" {% if is_cloud %}disabled{% endif %}>
                            <i class="bi bi-cloud-upload"></i> 2. AWS'ye GÃ¶nder
                        </button>
                    </div>

                    {% if is_cloud %}
                    <div class="alert alert-danger mt-3 small">
                        <i class="bi bi-x-circle"></i> Bu iÅŸlemler sunucu Ã¼zerinde (AWS) yapÄ±lamaz. LÃ¼tfen kendi
                        bilgisayarÄ±nÄ±zdan girin.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AWS OPERASYONLARI (Sadece Sunucuda aÃ§Ä±k) -->
        <div class="col-md-5 mb-4">
            <div class="card h-100 border-primary {% if not is_cloud %}bg-light opacity-50{% endif %}">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-hdd-network"></i> BULUT OPERASYON (Sunucuda Ã‡ek)
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        DoÄŸrudan AWS sunucusu Ã¼zerinden Bilyoner'e baÄŸlanÄ±r.
                        <br><b>Dikkat:</b> Sunucu IP'si bloklanabilir veya 403 hatasÄ± alabilir.
                    </p>

                    <div class="d-grid gap-2">
                        <button onclick="runServerScrape()" class="btn btn-primary" {% if not is_cloud %}disabled{% endif %}>
                           
                            <i class="bi bi-cloud-download"></i> Direkt Sunucuda Ã‡ek
                        </button>
                    </div>

                    {% if not is_cloud %}
                    <div class="alert alert-warning mt-3 small">
                        <i class="bi bi-exclamation-triangle"></i> Bu iÅŸlemi sadece <b>wfm-pro.com</b> Ã¼zerinden
                        yapabilirsiniz. Lokaldesiniz.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LOCAL FUNCTIONS ---
    async function runLocalScrape() {
        if (!confirm("TarayÄ±cÄ± aÃ§Ä±lacak ve Bilyoner verileri LOKAL veritabanÄ±na Ã§ekilecek. Devam?")) return;

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ã‡alÄ±ÅŸÄ±yor...';

        try {
            const res = await postData("{% url 'scrape_local_push' %}", { action: 'scrape_local' });
            if (res.success) {
                alert(`âœ… BAÅARILI: ${res.msg}`);
            } else {
                alert(`âŒ HATA: ${res.error}`);
            }
        } catch (e) { alert("BaÄŸlantÄ± HatasÄ±: " + e); }
        finally { btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function runAwsPush() {
        // PREFER DOMAIN OVER IP for SSL/HTTPS validity
        const DOMAIN_URL = 'https://wfm-pro.com/analysis/api/push-bulletin/';

        // If user previously saved an IP, force switch to Domain for HTTPS compatibility
        let savedUrl = localStorage.getItem('aws_target_url') || DOMAIN_URL;
        if (savedUrl.includes('34.203') || savedUrl.match(/[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/)) {
            savedUrl = DOMAIN_URL;
        }

        let targetUrl = prompt("AWS Hedef URL (HTTPS zorunlu):", savedUrl);
        if (!targetUrl) return;

        // Auto-fix URL formatting
        targetUrl = targetUrl.trim();

        // 1. Force HTTPS
        if (targetUrl.startsWith('http://')) {
            targetUrl = targetUrl.replace('http://', 'https://');
        } else if (!targetUrl.startsWith('https://')) {
            targetUrl = 'https://' + targetUrl;
        }

        // 2. Ensure Path
        if (!targetUrl.includes('/analysis/api/push-bulletin')) {
            targetUrl = targetUrl.replace(/\/+$/, "");
            targetUrl += '/analysis/api/push-bulletin/';
        }

        localStorage.setItem('aws_target_url', targetUrl);

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> GÃ¶nderiliyor...';

        try {
            const res = await postData("{% url 'scrape_local_push' %}", { action: 'push_to_aws', target_url: targetUrl });
            if (res.success) {
                alert(`âœ… GÃ–NDERÄ°LDÄ°: ${res.msg}`);
            } else {
                alert(`âŒ HATA: ${res.error}`);
            }
        } catch (e) {
            alert("BaÄŸlantÄ± HatasÄ±: " + e + "\n\nLÃ¼tfen URL'nin doÄŸru olduÄŸundan ve HTTPS kullandÄ±ÄŸÄ±nÄ±zdan emin olun.");
        }
        finally { btn.disabled = false; btn.innerHTML = originalText; }
    }

    // --- SERVER FUNCTIONS ---
    async function runServerScrape() {
        if (!confirm("DÄ°KKAT: AWS sunucusu Ã¼zerinden Ã§ekim denenecek. IP bloklanma riski vardÄ±r. Devam?")) return;

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sunucu Ã‡ekiyor...';

        try {
            // We reuse the scrape_local action effectively, but since we are ON the server, 
            // the view logic handles it the same way (it runs the scraper class).
            // The only difference is environment.
            const res = await postData("{% url 'scrape_local_push' %}", { action: 'scrape_local' });
            if (res.success) {
                alert(`âœ… SUNUCU GÃœNCELLENDÄ°: ${res.msg}`);
            } else {
                alert(`âŒ HATA (403/Blok olabilir): ${res.error}`);
            }
        } catch (e) { alert("BaÄŸlantÄ± HatasÄ±: " + e); }
        finally { btn.disabled = false; btn.innerHTML = originalText; }
    }

    async function postData(url, data) {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(data)
        });
        return response.json();
    }
</script>
{% endblock content %}